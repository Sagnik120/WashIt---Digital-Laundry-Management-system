generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum Role {
  ADMIN
  STUDENT
  STAFF
}

enum ActiveStatus {
  ACTIVE
  INACTIVE
}

enum OrderStatus {
  QR_NOT_SCANNED
  IN_PROGRESS
  PENDING
  COMPLETED
}

enum ComplaintStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  CLOSED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          Role
  emailVerified Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  studentProfile StudentProfile?
  staffProfile   StaffProfile?

  emailVerifications     EmailVerification[]
  passwordResets         PasswordReset[]
  notifications          Notification[]
  orderStatusHistory     OrderStatusHistory[]
  complaintStatusHistory ComplaintStatusHistory[]
  scannedQRCodes         QRCode[]                 @relation("QRCodeScanner")
  staffCodesClaimed      StaffCode[]              @relation("StaffCodeClaimedBy")

  @@index([role])
}

model StudentProfile {
  userId          String  @id
  fullName        String
  rollNumber      String  @unique
  hostelId        String
  roomNo          String
  phone           String?
  passingYear     Int?
  uniqueLaundryId String  @unique
  profileImageUrl String?

  user       User        @relation(fields: [userId], references: [id])
  hostel     Hostel      @relation(fields: [hostelId], references: [id])
  orders     Order[]     @relation("StudentOrders")
  complaints Complaint[] @relation("StudentComplaints")
}

model StaffProfile {
  userId         String @id
  fullName       String
  staffCodeValue String @unique

  user User @relation(fields: [userId], references: [id])
}

model EmailVerification {
  id         String    @id @default(uuid())
  userId     String
  otpHash    String
  expiresAt  DateTime
  status     String
  createdAt  DateTime  @default(now())
  verifiedAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PasswordReset {
  id               String    @id @default(uuid())
  userId           String
  tempPasswordHash String
  expiresAt        DateTime
  status           String
  createdAt        DateTime  @default(now())
  usedAt           DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  payload   Json
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Hostel {
  id         String       @id @default(uuid())
  hostelName String
  hostelCode String       @unique
  status     ActiveStatus @default(ACTIVE)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  students StudentProfile[]
}

model StaffCode {
  code            String       @id
  staffNameHint   String?
  status          ActiveStatus @default(ACTIVE)
  claimed         Boolean      @default(false)
  claimedByUserId String?
  createdAt       DateTime     @default(now())
  claimedAt       DateTime?

  claimedBy User? @relation("StaffCodeClaimedBy", fields: [claimedByUserId], references: [id])
}

model Order {
  id            String      @id @default(uuid())
  studentUserId String
  orderCode     String      @unique
  orderDate     DateTime
  orderStatus   OrderStatus @default(QR_NOT_SCANNED)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  student StudentProfile @relation("StudentOrders", fields: [studentUserId], references: [userId])

  items      OrderItem[]
  qrCode     QRCode?
  history    OrderStatusHistory[]
  complaints Complaint[]

  @@index([studentUserId])
}

model OrderItem {
  id       String  @id @default(uuid())
  orderId  String
  itemType String
  quantity Int
  remark   String?

  order  Order            @relation(fields: [orderId], references: [id])
  images OrderItemImage[]

  @@index([orderId])
}

model OrderItemImage {
  id          String   @id @default(uuid())
  orderItemId String
  imageUrl    String
  uploadedAt  DateTime @default(now())

  orderItem OrderItem @relation(fields: [orderItemId], references: [id])

  @@index([orderItemId])
}

model QRCode {
  orderId              String    @id
  qrPayload            String    @unique
  generatedAt          DateTime  @default(now())
  scannedAt            DateTime?
  scannedByStaffUserId String?

  order   Order @relation(fields: [orderId], references: [id])
  scanner User? @relation("QRCodeScanner", fields: [scannedByStaffUserId], references: [id])
}

model OrderStatusHistory {
  id              String       @id @default(uuid())
  orderId         String
  fromStatus      OrderStatus?
  toStatus        OrderStatus
  changedByUserId String
  changedAt       DateTime     @default(now())
  note            String?

  order     Order @relation(fields: [orderId], references: [id])
  changedBy User  @relation(fields: [changedByUserId], references: [id])

  @@index([orderId])
  @@index([changedByUserId])
}

model Complaint {
  id              String          @id @default(uuid())
  orderId         String
  studentUserId   String
  complaintStatus ComplaintStatus @default(OPEN)
  description     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  student StudentProfile @relation("StudentComplaints", fields: [studentUserId], references: [userId])

  images  ComplaintImage[]
  history ComplaintStatusHistory[]

  @@index([orderId])
  @@index([studentUserId])
}

model ComplaintImage {
  id          String   @id @default(uuid())
  complaintId String
  imageUrl    String
  uploadedAt  DateTime @default(now())

  complaint Complaint @relation(fields: [complaintId], references: [id])

  @@index([complaintId])
}

model ComplaintStatusHistory {
  id              String           @id @default(uuid())
  complaintId     String
  fromStatus      ComplaintStatus?
  toStatus        ComplaintStatus
  changedByUserId String
  changedAt       DateTime         @default(now())
  note            String?

  complaint Complaint @relation(fields: [complaintId], references: [id])
  changedBy User      @relation(fields: [changedByUserId], references: [id])

  @@index([complaintId])
  @@index([changedByUserId])
}
